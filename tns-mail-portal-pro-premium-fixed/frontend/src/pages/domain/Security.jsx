
import React, { useState } from 'react'
import { useParams } from 'react-router-dom'
import { useQuery, useQueryClient } from '@tanstack/react-query'
async function fetchMailboxes(domain){ const r=await fetch(`/api/mailboxes?domain=${encodeURIComponent(domain)}`); return r.json() }
async function fetchAppPw(mailbox){ const r=await fetch(`/api/app-passwords?mailbox=${encodeURIComponent(mailbox)}`); return r.json() }
export default function Security(){ const { domain } = useParams(); const qc=useQueryClient(); const { data }=useQuery({ queryKey:['mailboxes',domain], queryFn:()=>fetchMailboxes(domain)}); const mboxes=data?.items||[]; const [selected,setSelected]=useState(''); const { data: apppw }=useQuery({ enabled:!!selected, queryKey:['apppw',selected], queryFn:()=>fetchAppPw(selected)}); async function gen(e){ e.preventDefault(); const r=await fetch('/api/app-passwords',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({ mailbox:selected, comment:'Portal generated' })}); await r.json(); qc.invalidateQueries({ queryKey:['apppw',selected]}); } return (<div className="grid md:grid-cols-2 gap-3"><div className="card"><h3 className="font-semibold mb-2">Select mailbox</h3><select className="input" value={selected} onChange={e=>setSelected(e.target.value)}><option value="">-- choose mailbox --</option>{mboxes.map(m=> <option key={m.username} value={m.username}>{m.username}</option>)}</select>{selected && <div className="mt-3"><button onClick={gen} className="btn">Generate App Password</button></div>}</div><div className="card"><h3 className="font-semibold mb-2">App Passwords</h3>{!selected && <div className="text-tnsmuted">Choose a mailbox to view app passwords</div>}{selected && <pre className="output">{JSON.stringify(apppw?.items||[],null,2)}</pre>}</div></div>) }
